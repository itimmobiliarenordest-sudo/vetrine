<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Dashboard Vetrine</title>
<style>
  body { font-family: sans-serif; margin: 20px; }
  select { margin-bottom: 20px; }
  .griglia { display: flex; flex-direction: column; gap: 10px; }
  .riga { display: flex; gap: 10px; }
  .cella { width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; position: relative; border: 1px solid #ccc; cursor: pointer; }
  .cella.offline { background-color: #eee; }
  .cella.segnaposto { background-color: #fff; }
  .cella.ribasso { background-color: #ffdd57; }
  .cella.normale { background-color: #a0e7a0; }
  button { font-size: 10px; padding: 2px 5px; position: absolute; bottom: 2px; }
  .conteggi { margin-top: 20px; }
</style>
</head>
<body>

<h1>Dashboard Vetrine</h1>

<label for="seleziona-agenzia">Agenzia:</label>
<select id="seleziona-agenzia">
  <option value="portogruaro">Portogruaro</option>
  <option value="sanvito">San Vito</option>
  <option value="pordenone">Pordenone</option>
</select>

<div class="griglia" id="griglia"></div>

<div class="conteggi">
  <p>Cartelli totali: <span id="totale">0</span></p>
  <p>Ribassi da fare: <span id="ribassi">0</span></p>
  <p>Offline: <span id="offline">0</span></p>
</div>

<script>
const struttura = {
  portogruaro: [4,4,3,4,5],
  sanvito: [2,2,2],
  pordenone: [3,5]
};

const grigliaDiv = document.getElementById('griglia');
const selectAgenzia = document.getElementById('seleziona-agenzia');
let immobili = [];

async function caricaVetrine() {
  const res = await fetch("https://vetrine.it-immobiliarenordest.workers.dev/vetrine");
  const json = await res.json();
  if (!json.success) { console.error("Errore:", json.message); return; }
  immobili = json.data;
  renderGriglia();
}

function renderGriglia() {
  const agenzia = selectAgenzia.value;
  grigliaDiv.innerHTML = '';
  
  const immobiliAgenzia = immobili.filter(i => i.agenzia === agenzia);

  let countRibasso = 0;
  let countOffline = 0;

  let indice = 0;

  struttura[agenzia].forEach((colonne, rigaIdx) => {
    const riga = document.createElement('div');
    riga.classList.add('riga');

    for (let c = 0; c < colonne; c++) {
      const immobile = immobiliAgenzia[indice];
      const cella = document.createElement('div');
      cella.classList.add('cella');

      if (!immobile) {
        cella.classList.add('offline');
        countOffline++;
      } else if (immobile.segnaposto) {
        cella.classList.add('segnaposto');
      } else if (immobile.prezzo_myagency < immobile.prezzo) {
        cella.classList.add('ribasso');
        countRibasso++;
      } else {
        cella.classList.add('normale');
      }

      // Pulsante ribasso
      if (immobile && !immobile.segnaposto) {
        const btn = document.createElement('button');
        btn.textContent = "Ribasso";
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (confirm(`Confermi ribasso per ${immobile.rif}?`)) {
            alert(`Ribasso eseguito per ${immobile.rif}`);
            // Aggiorna stato locale per la visualizzazione
            immobile.prezzo_myagency = immobile.prezzo_myagency * 0.95;
            renderGriglia();
          }
        });
        cella.appendChild(btn);
      }

      // Toggle segnaposto al click
      cella.addEventListener('click', () => {
        if (immobile) {
          immobile.segnaposto = !immobile.segnaposto;
          renderGriglia();
        }
      });

      riga.appendChild(cella);
      indice++;
    }

    grigliaDiv.appendChild(riga);
  });

  document.getElementById('totale').textContent = immobiliAgenzia.length;
  document.getElementById('ribassi').textContent = countRibasso;
  document.getElementById('offline').textContent = countOffline;
}

selectAgenzia.addEventListener('change', renderGriglia);

caricaVetrine();
</script>

</body>
</html>
