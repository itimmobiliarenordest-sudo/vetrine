<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Dashboard Vetrine</title>
<style>
  html, body {
    height: 100%;
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f4f4f9;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
  }

  h1 {
    text-align: center;
    color: #b30933;
    margin-top: 20px;
  }

  label { font-weight: bold; }
  select { padding: 5px 10px; margin: 10px 0; font-size: 14px; }
  
  /* Stile per il campo di ricerca */
  .cerca-container {
    margin-top: 20px;
    display: flex;
    gap: 10px;
    align-items: center;
  }
  
  #inputRicerca {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 14px;
  }

  .griglia {
    display: flex;
    flex-direction: column;
    gap: 15px;
    align-items: center;
  }

  .riga { display: flex; gap: 10px; justify-content: center; }

  .blocco {
    display: flex;
    gap: 8px;
    padding: 5px;
    border-right: 3px solid #4c565c;
    transition: transform 0.3s;
  }

  .blocco:last-child { border-right: none; }

  .cella {
    width: 90px; height: 80px;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    box-sizing: border-box;
    cursor: pointer;
    padding: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: transform 0.3s, box-shadow 0.3s, background-color 0.3s;
    text-align: center;
    overflow-wrap: break-word;
  }

  .cella:hover { transform: translateY(-3px); box-shadow: 0 5px 12px rgba(0,0,0,0.2); }

  /* Classi per stato */
  .cella.offline { background-color: #f0f0f0; color: #999; }
  .cella.segnaposto { background-color: #87a0fa; color: white; }
  .cella.ribasso { background-color: #ffeb99; color: #555; }
  .cella.normale { background-color: #a0e7a0; color: #333; }
  
  /* NUOVA CLASSE PER EVIDENZIAZIONE RICERCA */
  .cella.evidenziato {
    background-color: #ff9900 !important; /* Arancione brillante, sovrascrive */
    color: white !important;
    transform: scale(1.05) translateY(-5px); 
    box-shadow: 0 8px 20px rgba(255, 153, 0, 0.5);
    border: 3px solid white; /* Bordo bianco per contrasto */
  }

  .cella .prezzo-vecchio {
    text-decoration: line-through;
    font-weight: normal; /* Modificato: forza normale per non essere grassetto */
    font-size: 0.85em;
    color: #666;
    margin-bottom: 2px;
    word-break: break-word;
  }

  .cella .prezzo-nuovo {
    font-weight: bold; /* Aggiunto: per enfatizzare il prezzo nuovo/attuale */
    color: black;
    margin-bottom: 2px;
    word-break: break-word;
  }

  .cella .comune {
    font-size: 0.8em;
    color: #333;
    word-break: break-word;
  }

  .cella .rif {
    font-weight: bold;
    margin-bottom: 2px;
    word-break: break-word;
  }

  button {
    margin-top: 4px;
    font-size: 10px;
    padding: 2px 5px;
    border: none;
    border-radius: 5px;
    background-color: #ffb74d;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.3s;
  }

  button:hover { 
      background-color: #ffa726; 
      transform: scale(1.1); 
  }
  
  #bottoneCerca { /* Stile specifico per il pulsante cerca */
      padding: 8px 15px;
      font-size: 14px;
      margin-top: 0;
  }

  .conteggi {
    margin-top: 20px;
    font-weight: bold;
    display: flex;
    gap: 30px;
    justify-content: center;
    font-size: 14px;
  }

  /* Animazione fade */
  .fade {
    animation: fadeIn 0.4s ease-in-out;
  }

  @keyframes fadeIn {
    0% { opacity: 0; transform: scale(0.9); }
    100% { opacity: 1; transform: scale(1); }
  }
</style>
</head>
<body>

<h1>Dashboard Vetrine</h1>

<label for="selezionaAgenzia">Seleziona Agenzia:</label>
<select id="selezionaAgenzia">
  <option value="portogruaro">Portogruaro</option>
  <option value="sanvito">San Vito</option>
  <option value="pordenone">Pordenone</option>
</select>

<div class="griglia" id="griglia"></div>

<div class="cerca-container">
    <input type="text" id="inputRicerca" placeholder="Cerca Riferimento (es. 1234)">
    <button id="bottoneCerca">Cerca</button>
</div>

<div class="conteggi">
  <div>Cartelli totali: <span id="totale">0</span></div>
  <div>Ribassi da fare: <span id="ribassi">0</span></div>
  <div>Offline: <span id="offline">0</span></div>
</div>

<script>
const agenzieBlocchi = {
  portogruaro: [4, 4, 3, 4, 5],
  sanvito: [2, 2, 2],
  pordenone: [3, 5]
};
const righe = 3;
let immobili = [];

const grigliaDiv = document.getElementById('griglia');
const selectAgenzia = document.getElementById('selezionaAgenzia');
const inputRicerca = document.getElementById('inputRicerca');
const bottoneCerca = document.getElementById('bottoneCerca');

// Variabile per tenere traccia del riferimento da evidenziare
let rifDaCercare = '';

async function caricaVetrine() {
  // L'URL è stato commentato per consentire il funzionamento in locale senza un server attivo, 
  // ma DEVE essere riattivato quando usato in produzione.
  /*
  const res = await fetch("https://vetrine.it-immobiliarenordest.workers.dev/vetrine");
  const json = await res.json();
  if (!json.success) { console.error("Errore:", json.message); return; }
  immobili = json.data;
  */

  // Dati di ESEMPIO per il test in locale
  immobili = [
    { rif: '1234', comune: 'Porto', prezzo: 150000, prezzo_myagency: 140000, agenzia: 'portogruaro', segnaposto: false },
    { rif: '1235', comune: 'Porto', prezzo: 130000, prezzo_myagency: 130000, agenzia: 'portogruaro', segnaposto: false },
    { rif: '1236', comune: 'Porto', prezzo: 180000, prezzo_myagency: 160000, agenzia: 'portogruaro', segnaposto: false },
    { rif: '1237', comune: 'Porto', prezzo: 0, prezzo_myagency: 0, agenzia: 'portogruaro', segnaposto: false },
    { rif: '4567', comune: 'S. Vito', prezzo: 200000, prezzo_myagency: 200000, agenzia: 'sanvito', segnaposto: false },
    { rif: '4568', comune: 'S. Vito', prezzo: 0, prezzo_myagency: 0, agenzia: 'sanvito', segnaposto: false },
    { rif: '7890', comune: 'Pordenone', prezzo: 120000, prezzo_myagency: 120000, agenzia: 'pordenone', segnaposto: false },
    { rif: 'RIBB', comune: 'Porto', prezzo: 220000, prezzo_myagency: 215000, agenzia: 'portogruaro', segnaposto: false },
    { rif: '9999', comune: 'Porto', prezzo: 0, prezzo_myagency: 0, agenzia: 'portogruaro', segnaposto: false },
    // Aggiungi abbastanza elementi per riempire la griglia
    ...Array(30).fill(null).map((_, i) => ({ 
        rif: `A${100 + i}`, 
        comune: 'Dummy', 
        prezzo: 100000 + i * 1000, 
        prezzo_myagency: 100000 + i * 1000, 
        agenzia: 'portogruaro', 
        segnaposto: false 
    })),
  ];
  
  renderGriglia();
}

function renderGriglia() {
  const agenzia = selectAgenzia.value;
  const blocchi = agenzieBlocchi[agenzia];
  // Filtra immobili che corrispondono all'agenzia selezionata E quelli che non sono stati 'accettati' come ribasso
  const immobiliFiltrati = immobili.filter(i => i.agenzia === agenzia); 

  grigliaDiv.innerHTML = '';
  let indice = 0;
  let countRibasso = 0;
  let countOffline = 0;

  // Calcola il numero totale di celle che la griglia dovrebbe avere per riempire gli spazi vuoti
  const celleTotali = blocchi.reduce((sum, current) => sum + current, 0) * righe;
  const immobiliConSegnaposto = [...immobiliFiltrati];

  // Riempie le celle rimanenti con placeholder (in base al numero totale necessario)
  while (immobiliConSegnaposto.length < celleTotali) {
      immobiliConSegnaposto.push(null);
  }

  for (let r = 0; r < righe; r++) {
    const rigaDiv = document.createElement('div');
    rigaDiv.classList.add('riga');

    blocchi.forEach((colonne) => {
      const bloccoDiv = document.createElement('div');
      bloccoDiv.classList.add('blocco');

      for (let c = 0; c < colonne; c++) {
        const immobile = immobiliConSegnaposto[indice];
        const cella = document.createElement('div');
        cella.classList.add('cella', 'fade');

        if (!immobile || immobile.prezzo === 0) {
          cella.classList.add('offline');
          cella.textContent = "OFFLINE";
          countOffline++;

        } else if (immobile.segnaposto) {
          cella.classList.add('segnaposto');
          cella.textContent = "SEGNAPOSTO";

        } else {
          const isRibasso = immobile.prezzo_myagency < immobile.prezzo;

          if (isRibasso) {
            cella.classList.add('ribasso');
            countRibasso++;
            cella.innerHTML = `
              <div class="prezzo-vecchio">${immobile.prezzo} €</div>
              <div class="prezzo-nuovo">↓ ${immobile.prezzo_myagency} €</div>
              <div class="comune">${immobile.comune}</div>
            `;
          } else {
            cella.classList.add('normale');
            cella.innerHTML = `
              <div class="rif">${immobile.rif}</div>
              <div class="prezzo-nuovo">${immobile.prezzo} €</div>
              <div class="comune">${immobile.comune}</div>
            `;
          }
        }
        
        // LOGICA DI EVIDENZIAZIONE: Controlla se il riferimento corrisponde alla ricerca
        if (immobile && immobile.rif && rifDaCercare && immobile.rif.toLowerCase() === rifDaCercare.toLowerCase()) {
            cella.classList.add('evidenziato');
            // Scorrimento al cartello trovato dopo un breve ritardo per l'animazione
            setTimeout(() => cella.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
        }


        // Aggiungi pulsante Ribasso SOLO se non è segnaposto e c'è un ribasso
        if (immobile && !immobile.segnaposto && immobile.prezzo_myagency < immobile.prezzo) {
          const btn = document.createElement('button');
          btn.textContent = "Ribasso";
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (confirm(`Confermi ribasso per ${immobile.rif}?`)) {
              immobile.prezzo = immobile.prezzo_myagency;
              renderGriglia();
            }
          });
          cella.appendChild(btn);
        }
        
        // Logica click per segnaposto (se non è offline e non è vuoto)
        if (immobile) {
            cella.addEventListener('click', () => {
              immobile.segnaposto = !immobile.segnaposto;
              renderGriglia();
            });
        }

        bloccoDiv.appendChild(cella);
        indice++;
      }

      rigaDiv.appendChild(bloccoDiv);
    });

    grigliaDiv.appendChild(rigaDiv);
  }

  // I conteggi sono basati sul numero reale di immobili filtrati, non sul totale delle celle
  document.getElementById('totale').textContent = immobiliFiltrati.length;
  document.getElementById('ribassi').textContent = countRibasso;
  document.getElementById('offline').textContent = countOffline;
}

// FUNZIONE PER GESTIRE LA RICERCA
function gestisciRicerca() {
    const valore = inputRicerca.value.trim();
    if (valore) {
        // Imposta il riferimento da cercare (case-insensitive)
        rifDaCercare = valore;
    } else {
        // Se l'input è vuoto, resetta la ricerca
        rifDaCercare = '';
    }
    renderGriglia(); // Ricarica la griglia per applicare/rimuovere l'evidenziazione
}


selectAgenzia.addEventListener('change', renderGriglia);
bottoneCerca.addEventListener('click', gestisciRicerca);
inputRicerca.addEventListener('keypress', (e) => { 
    if (e.key === 'Enter') {
        gestisciRicerca();
    }
});
caricaVetrine();
</script>

</body>
</html>
