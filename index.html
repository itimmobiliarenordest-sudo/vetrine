<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Vetrine</title>
<style>
body {
    font-family: 'Segoe UI', sans-serif;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    background: #f0f2f5;
    margin: 0;
    padding: 20px;
}

.container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 30px;
}

.griglia {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.cella {
    width: 100px;
    min-height: 100px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 5px;
    text-align: center;
    transition: transform 0.3s, background-color 0.3s;
}

.cella:hover {
    transform: scale(1.05);
}

.cella.ribasso {
    background-color: #fff176; /* giallo chiaro */
}

.cella.offline {
    background-color: #e0e0e0;
}

.cella.segnaposto {
    background-color: #90caf9; /* azzurro */
}

button {
    margin-top: 4px;
    font-size: 10px;
    padding: 2px 5px;
    border: none;
    border-radius: 5px;
    background-color: #ffb74d; /* giallo/arancione */
    color: white;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.3s;
}

button:hover { 
    background-color: #ffa726; 
    transform: scale(1.1); 
}

input.rif-input {
    width: 60px;
    font-size: 12px;
    text-align: center;
    margin-bottom: 4px;
}
</style>
</head>
<body>
<div class="container">
    <select id="selettore-agenzia">
        <option value="portogruaro">Portogruaro</option>
        <option value="sanvito">San Vito</option>
        <option value="pordenone">Pordenone</option>
    </select>
    <div id="totale-cartelli">Totale cartelli: <span id="totale">0</span></div>
    <div class="griglia" id="griglia"></div>
</div>

<script>
const agenzieStruttura = {
    portogruaro: [4,4,3,4,5],
    sanvito: [2,2,2],
    pordenone: [3,5]
};

const colori = {
    ribasso: 'ribasso',
    segnaposto: 'segnaposto',
    offline: 'offline'
};

let jsonData = [];

async function caricaVetrine() {
    const res = await fetch("https://vetrine.it-immobiliarenordest.workers.dev/vetrine");
    const json = await res.json();
    if (!json.success) return;

    jsonData = json.data;
    renderGriglia();
}

function renderGriglia() {
    const agenzia = document.getElementById("selettore-agenzia").value;
    const struttura = agenzieStruttura[agenzia];
    const griglia = document.getElementById("griglia");
    griglia.innerHTML = "";

    const immobiliAgenzia = jsonData.filter(i => i.agenzia === agenzia);
    document.getElementById("totale").textContent = immobiliAgenzia.length;

    let index = 0;
    struttura.forEach((colonne, idxVetrina) => {
        for(let r=0; r<3; r++) { // 3 righe fisse
            const riga = document.createElement('div');
            riga.style.display = 'flex';
            riga.style.gap = '8px';
            for(let c=0; c<colonne; c++) {
                const cella = document.createElement('div');
                cella.className = 'cella';
                const immobile = immobiliAgenzia[index] || null;

                if (!immobile) {
                    cella.classList.add(colori.offline);
                } else {
                    if (immobile.segnaposto) cella.classList.add(colori.segnaposto);
                    else if (immobile.prezzo_myagency < immobile.prezzo) cella.classList.add(colori.ribasso);

                    const inputRif = document.createElement('input');
                    inputRif.value = immobile ? immobile.rif : '';
                    inputRif.className = 'rif-input';
                    inputRif.addEventListener('change', () => {
                        if(immobile) immobile.rif = inputRif.value;
                    });
                    cella.appendChild(inputRif);

                    const prezzo = document.createElement('div');
                    prezzo.textContent = immobile ? immobile.prezzo_myagency : '';
                    cella.appendChild(prezzo);

                    const comune = document.createElement('div');
                    comune.textContent = immobile ? immobile.comune : '';
                    cella.appendChild(comune);

                    if (immobile && cella.classList.contains('ribasso')) {
                        const btn = document.createElement('button');
                        btn.textContent = "Ribasso";
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            immobile.prezzo_myagency = Math.round(immobile.prezzo_myagency * 0.95);
                            renderGriglia();
                        });
                        cella.appendChild(btn);
                    }
                }

                riga.appendChild(cella);
                index++;
            }
            griglia.appendChild(riga);
        }
        // separatore pi√π spesso tra vetrine
        const sep = document.createElement('div');
        sep.style.height = '12px';
        griglia.appendChild(sep);
    });
}

document.getElementById("selettore-agenzia").addEventListener('change', renderGriglia);

caricaVetrine();
</script>
</body>
</html>
