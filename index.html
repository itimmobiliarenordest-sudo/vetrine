<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Dashboard Vetrine</title>
<style>
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    background: #f4f4f9; 
    margin: 20px; 
    color: #333;
  }
  h1 { text-align: center; color: #b35933; }
  label { font-weight: bold; }
  select { padding: 5px 10px; margin: 10px 0; font-size: 14px; }
  
  .griglia { display: flex; flex-direction: column; gap: 15px; }
  .riga { display: flex; gap: 10px; }
  .blocco {
    display: flex; gap: 8px;
    padding: 5px;
    border-right: 3px solid #b35933;
  }
  .blocco:last-child { border-right: none; }
  
  .cella {
    width: 90px; height: 80px; 
    border-radius: 12px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-size: 12px; box-sizing: border-box; cursor: pointer; padding: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .cella:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }

  .cella.offline { background-color: #f0f0f0; color: #999; }
  .cella.segnaposto { background-color: #fff3e0; color: #555; }
  .cella.ribasso { background-color: #ffeb99; color: #555; }
  .cella.normale { background-color: #a0e7a0; color: #333; }

  button {
    margin-top: 4px; 
    font-size: 10px; 
    padding: 2px 5px; 
    border: none; 
    border-radius: 5px; 
    background-color: #b35933; 
    color: white; 
    cursor: pointer;
    transition: background-color 0.2s;
  }
  button:hover { background-color: #8b0a25; }

  .conteggi { 
    margin-top: 20px; 
    font-weight: bold;
    display: flex;
    gap: 30px;
    justify-content: center;
    font-size: 14px;
  }
</style>
</head>
<body>

<h1>Dashboard Vetrine</h1>

<label for="selezionaAgenzia">Seleziona Agenzia:</label>
<select id="selezionaAgenzia">
  <option value="portogruaro">Portogruaro</option>
  <option value="sanvito">San Vito</option>
  <option value="pordenone">Pordenone</option>
</select>

<div class="griglia" id="griglia"></div>

<div class="conteggi">
  <div>Cartelli totali: <span id="totale">0</span></div>
  <div>Ribassi da fare: <span id="ribassi">0</span></div>
  <div>Offline: <span id="offline">0</span></div>
</div>

<script>
const agenzieBlocchi = {
  portogruaro: [4, 4, 3, 4, 5],
  sanvito: [2, 2, 2],
  pordenone: [3, 5]
};

const righe = 3;
let immobili = [];

const grigliaDiv = document.getElementById('griglia');
const selectAgenzia = document.getElementById('selezionaAgenzia');

async function caricaVetrine() {
  const res = await fetch("https://vetrine.it-immobiliarenordest.workers.dev/vetrine");
  const json = await res.json();
  if (!json.success) { console.error("Errore:", json.message); return; }
  immobili = json.data;
  renderGriglia();
}

function renderGriglia() {
  const agenzia = selectAgenzia.value;
  const blocchi = agenzieBlocchi[agenzia];
  const immobiliFiltrati = immobili.filter(i => i.agenzia === agenzia);

  grigliaDiv.innerHTML = '';
  let indice = 0;
  let countRibasso = 0;
  let countOffline = 0;

  for (let r = 0; r < righe; r++) {
    const rigaDiv = document.createElement('div');
    rigaDiv.classList.add('riga');

    blocchi.forEach((colonne, bloccoIdx) => {
      const bloccoDiv = document.createElement('div');
      bloccoDiv.classList.add('blocco');

      for (let c = 0; c < colonne; c++) {
        const immobile = immobiliFiltrati[indice];
        const cella = document.createElement('div');
        cella.classList.add('cella');

        if (!immobile || immobile.prezzo === 0) {
          cella.classList.add('offline');
          cella.innerHTML = "OFFLINE";
          countOffline++;
        } else if (immobile.segnaposto) {
          cella.classList.add('segnaposto');
          cella.innerHTML = "SEGNAPOSTO";
        } else {
          if (immobile.prezzo_myagency < immobile.prezzo) {
            cella.classList.add('ribasso');
            countRibasso++;
          } else {
            cella.classList.add('normale');
          }
          cella.innerHTML = `${immobile.rif}<br>${immobile.prezzo_myagency}<br>${immobile.comune}`;
        }

        // Pulsante ribasso
        if (immobile && !immobile.segnaposto && immobile.prezzo_myagency > 0) {
          const btn = document.createElement('button');
          btn.textContent = "Ribasso";
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (confirm(`Confermi ribasso per ${immobile.rif}?`)) {
              immobile.prezzo_myagency = Math.round(immobile.prezzo_myagency * 0.95);
              renderGriglia();
            }
          });
          cella.appendChild(btn);
        }

        // Toggle segnaposto
        cella.addEventListener('click', () => {
          if (immobile) {
            immobile.segnaposto = !immobile.segnaposto;
            renderGriglia();
          }
        });

        bloccoDiv.appendChild(cella);
        indice++;
      }

      rigaDiv.appendChild(bloccoDiv);
    });

    grigliaDiv.appendChild(rigaDiv);
  }

  document.getElementById('totale').textContent = immobiliFiltrati.length;
  document.getElementById('ribassi').textContent = countRibasso;
  document.getElementById('offline').textContent = countOffline;
}

selectAgenzia.addEventListener('change', renderGriglia);
caricaVetrine();
</script>

</body>
</html>
