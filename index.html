<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Dashboard Vetrine</title>
<style>
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
  .normale { background-color: white; }
  .ribasso { background-color: #fff3b0; }
  .segnaposto { background-color: #e0e0e0; }
  .offline { background-color: #f8d7da; }
  button.ribasso { padding: 2px 5px; font-size: 0.8em; }
</style>
</head>
<body>

<h2>Dashboard Vetrine</h2>

<label for="agenziaSelect">Seleziona Agenzia:</label>
<select id="agenziaSelect">
    <option value="portogruaro">Portogruaro</option>
    <option value="sanvito">San Vito</option>
    <option value="pordenone">Pordenone</option>
</select>

<div>
    <p>Totale cartelli: <span id="totale">0</span></p>
    <p>Ribassi da fare: <span id="ribassi">0</span></p>
    <p>Offline: <span id="offline">0</span></p>
    <p>Segnaposto: <span id="segnaposto">0</span></p>
</div>

<table id="vetrinaTable">
  <thead>
    <tr>
      <th>Vetrina</th>
      <th>Rif</th>
      <th>Comune</th>
      <th>Prezzo</th>
      <th>Prezzo MyAgency</th>
      <th>Segnaposto</th>
      <th>Azioni</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
async function caricaVetrine() {
    const res = await fetch("https://vetrine.it-immobiliarenordest.workers.dev/vetrine");
    const json = await res.json();
    if (!json.success) { console.error("Errore:", json.message); return; }

    const tuttiImmobili = json.data;

    const agenziaSelect = document.getElementById("agenziaSelect");
    const tableBody = document.querySelector("#vetrinaTable tbody");

    function aggiornaTabella() {
        const agenzia = agenziaSelect.value;
        tableBody.innerHTML = "";

        const cartelli = tuttiImmobili.filter(i => i.agenzia === agenzia);

        let ribassiCount = 0, segnapostoCount = 0, offlineCount = 0;

        // Creiamo mappa dei cartelli attesi per calcolare offline
        const cartelliAttesi = agenzia === "portogruaro" ? 60 : agenzia === "sanvito" ? 18 : 24;
        const presentiSet = new Set(cartelli.map(i => i.vetrina));

        for (let i = 1; i <= cartelliAttesi; i++) {
            const codice = (agenzia === "portogruaro" ? "PO-" : agenzia === "sanvito" ? "SA-" : "PN-") + String(i).padStart(2,"0");
            const immobile = cartelli.find(c => c.vetrina === codice);
            const tr = document.createElement("tr");

            if (!immobile) {
                // Offline = cartello mancante
                tr.className = "offline";
                tr.innerHTML = `<td>${codice}</td><td>-</td><td>-</td><td>0</td><td>0</td><td>No</td><td></td>`;
                offlineCount++;
            } else if (immobile.segnaposto) {
                tr.className = "segnaposto";
                tr.innerHTML = `<td>${immobile.vetrina}</td><td>${immobile.rif}</td><td>${immobile.comune}</td><td>${immobile.prezzo}</td><td>${immobile.prezzo_myagency}</td><td>Sì</td><td></td>`;
                segnapostoCount++;
            } else if (immobile.prezzo_myagency < immobile.prezzo) {
                tr.className = "ribasso";
                tr.innerHTML = `<td>${immobile.vetrina}</td><td>${immobile.rif}</td><td>${immobile.comune}</td><td>${immobile.prezzo}</td><td>${immobile.prezzo_myagency}</td><td>No</td>
                                <td><button class="ribasso" onclick="confermaRibasso('${immobile.rif}')">Ribassa</button></td>`;
                ribassiCount++;
            } else {
                tr.className = "normale";
                tr.innerHTML = `<td>${immobile.vetrina}</td><td>${immobile.rif}</td><td>${immobile.comune}</td><td>${immobile.prezzo}</td><td>${immobile.prezzo_myagency}</td><td>No</td><td></td>`;
            }
            tableBody.appendChild(tr);
        }

        document.getElementById("totale").textContent = cartelliAttesi;
        document.getElementById("ribassi").textContent = ribassiCount;
        document.getElementById("offline").textContent = offlineCount;
        document.getElementById("segnaposto").textContent = segnapostoCount;
    }

    agenziaSelect.addEventListener("change", aggiornaTabella);
    aggiornaTabella();
}

function confermaRibasso(rif) {
    if (confirm(`Confermi il ribasso per l'immobile ${rif}?`)) {
        alert(`Ribasso confermato per immobile ${rif}`);
        // qui si potrà chiamare API per aggiornare prezzo
    }
}

caricaVetrine();
</script>

</body>
</html>
