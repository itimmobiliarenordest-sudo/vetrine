<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Vetrine</title>
<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f5f5f5;
}

select {
    padding: 6px 10px;
    font-size: 16px;
    margin-bottom: 20px;
}

.griglia {
    display: flex;
    flex-direction: column;
    gap: 25px;
}

/* Ogni blocco vetrina (es: 4 | 4 | 3 | 4 | 5) */
.vetrina {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding-bottom: 20px;
    border-bottom: 4px solid #ccc;
}

.riga {
    display: flex;
    gap: 10px;
}

.cella {
    width: 120px;
    height: 120px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    padding: 8px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    text-align: center;
    font-size: 14px;
}

.cella.ribasso {
    background-color: #ffec80;
}

.cella.segnaposto {
    background-color: #a8d0ff;
}

.cella.offline {
    background-color: #d8d8d8;
}

button.ribasso-btn {
    margin-top: 5px;
    background-color: #ffae42;
    border: none;
    padding: 4px 6px;
    border-radius: 6px;
    cursor: pointer;
    color: white;
    font-size: 12px;
}

input.rif-input {
    width: 80%;
    font-size: 12px;
    text-align: center;
    margin-bottom: 6px;
}
</style>
</head>
<body>

<select id="selettore-agenzia">
    <option value="portogruaro">Portogruaro</option>
    <option value="sanvito">San Vito</option>
    <option value="pordenone">Pordenone</option>
</select>

<div class="griglia" id="griglia"></div>

<script>
const agenzieStruttura = {
    portogruaro: [4,4,3,4,5],
    sanvito: [2,2,2],
    pordenone: [3,5]
};

let jsonData = [];

async function caricaVetrine() {
    const res = await fetch("https://vetrine.it-immobiliarenordest.workers.dev/vetrine");
    const json = await res.json();
    if (!json.success) return;

    jsonData = json.data;
    renderGriglia();
}

function renderGriglia() {
    const agenzia = document.getElementById("selettore-agenzia").value;
    const struttura = agenzieStruttura[agenzia];
    const griglia = document.getElementById("griglia");
    griglia.innerHTML = "";

    const immobili = jsonData.filter(i => i.agenzia === agenzia);
    let index = 0;

    struttura.forEach(colonne => {
        const blocco = document.createElement("div");
        blocco.className = "vetrina";

        for (let r = 0; r < 3; r++) {
            const riga = document.createElement("div");
            riga.className = "riga";

            for (let c = 0; c < colonne; c++) {
                const cella = document.createElement("div");
                cella.className = "cella";

                const imm = immobili[index] || null;

                if (!imm) {
                    cella.classList.add("offline");
                } else {
                    if (imm.segnaposto) cella.classList.add("segnaposto");
                    else if (imm.prezzo_myagency < imm.prezzo) cella.classList.add("ribasso");

                    const inputRif = document.createElement("input");
                    inputRif.className = "rif-input";
                    inputRif.value = imm.rif ?? "";
                    inputRif.addEventListener("change", () => imm.rif = inputRif.value);
                    cella.appendChild(inputRif);

                    const prezzo = document.createElement("div");
                    prezzo.textContent = imm.prezzo_myagency;
                    cella.appendChild(prezzo);

                    const comune = document.createElement("div");
                    comune.textContent = imm.comune;
                    cella.appendChild(comune);

                    if (cella.classList.contains("ribasso")) {
                        const btn = document.createElement("button");
                        btn.textContent = "Ribasso";
                        btn.className = "ribasso-btn";
                        btn.onclick = () => {
                            imm.prezzo_myagency = Math.round(imm.prezzo_myagency * 0.95);
                            renderGriglia();
                        };
                        cella.appendChild(btn);
                    }
                }

                riga.appendChild(cella);
                index++;
            }

            blocco.appendChild(riga);
        }

        griglia.appendChild(blocco);
    });
}

document.getElementById("selettore-agenzia").addEventListener("change", renderGriglia);

caricaVetrine();
</script>

</body>
</html>
