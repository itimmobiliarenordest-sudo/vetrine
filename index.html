<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Dashboard Vetrine</title>
<style>
Â  html, body {
Â  Â  height: 100%;
Â  Â  margin: 0;
Â  Â  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
Â  Â  background: #f4f4f9;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  align-items: center;
Â  Â  justify-content: flex-start;
Â  }

Â  h1 {
Â  Â  text-align: center;
Â  Â  color: #b30933;
Â  Â  margin-top: 20px;
Â  Â  margin-bottom: 10px;
Â  }
Â Â 
Â  /* CONTENITORI PRINCIPALI E FORM */
Â  .dashboard-controls {
Â  Â  margin-bottom: 20px;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  gap: 15px;
Â  Â  align-items: center;
Â  }

Â  .form-group {
Â  Â  display: flex;
Â  Â  gap: 10px;
Â  Â  align-items: center;
Â  }

Â  /* STILE SELECT E LABEL */
Â  label {Â 
Â  Â  font-weight: bold;Â 
Â  Â  color: #4c565c;
Â  Â  margin-right: 10px;
Â  }
Â  select {Â 
Â  Â  padding: 8px 15px;Â 
Â  Â  margin: 0; /* Rimosso margine verticale */
Â  Â  font-size: 16px;Â 
Â  Â  border: 2px solid #b30933;Â 
Â  Â  border-radius: 8px;Â 
Â  Â  background-color: white;Â 
Â  Â  cursor: pointer;
Â  Â  appearance: none;
Â  Â  -webkit-appearance: none;
Â  Â  -moz-appearance: none;
Â  Â  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23b30933' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
Â  Â  background-repeat: no-repeat;
Â  Â  background-position: right 10px center;
Â  Â  padding-right: 30px;Â 
Â  Â  transition: border-color 0.3s, box-shadow 0.3s;
Â  }

Â  select:focus {
Â  Â  border-color: #007bff;
Â  Â  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
Â  Â  outline: none;
Â  }
Â Â 
Â  /* Stile per i campi di ricerca/input */
Â  .cerca-container, .sostituzione-container {
Â  Â  display: flex;
Â  Â  gap: 10px;
Â  Â  align-items: center;
Â  }
Â Â 
Â  #inputRicerca, .sostituzione-container input[type="text"] {
Â  Â  padding: 8px;
Â  Â  border: 1px solid #ccc;
Â  Â  border-radius: 5px;
Â  Â  font-size: 14px;
Â  Â  width: 100px; /* Rendi gli input dei RIF piÃ¹ compatti */
Â  }
Â Â 
Â  /* Stile generale per i bottoni */
Â  button {
Â  Â  padding: 8px 15px;
Â  Â  font-size: 14px;
Â  Â  border: none;
Â  Â  border-radius: 5px;
Â  Â  background-color: #b30933; /* Rosso principale */
Â  Â  color: white;
Â  Â  cursor: pointer;
Â  Â  transition: background-color 0.3s;
Â  }
Â  button:hover {
Â  Â  background-color: #8c0727;
Â  }

Â  #bottoneCerca {
Â  Â  background-color: #007bff;
Â  }
Â  #bottoneCerca:hover {
Â  Â  background-color: #0056b3;
Â  }
Â  #bottoneSostituzione {
Â  Â  background-color: #28a745; /* Verde per l'azione di Sostituzione */
Â  }
Â  #bottoneSostituzione:hover {
Â  Â  background-color: #1e7e34;
Â  }

Â  .griglia {
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  gap: 15px;
Â  Â  align-items: center;
Â  Â  min-height: 400px;
Â  Â  position: relative;
Â  }

Â  .riga { display: flex; gap: 10px; justify-content: center; }

Â  .blocco {
Â  Â  display: flex;
Â  Â  gap: 8px;
Â  Â  padding: 5px;
Â  Â  border-right: 3px solid #4c565c;
Â  Â  transition: transform 0.3s;
Â  }

Â  .blocco:last-child { border-right: none; }

Â  .cella {
Â  Â  width: 90px; height: 80px;
Â  Â  border-radius: 12px;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  align-items: center;
Â  Â  justify-content: center;
Â  Â  font-size: 12px;
Â  Â  box-sizing: border-box;
Â  Â  cursor: pointer;
Â  Â  padding: 5px;
Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
Â  Â  transition: transform 0.3s, box-shadow 0.3s, background-color 0.3s;
Â  Â  text-align: center;
Â  Â  overflow-wrap: break-word;
Â  Â  position: relative;
Â  }

Â  .cella:hover { transform: translateY(-3px); box-shadow: 0 5px 12px rgba(0,0,0,0.2); }

Â  /* Classi STATI */
Â  .cella.rosso { 
Â  Â  background-color: #fce8e8;Â 
Â  Â  color: #b30933;Â 
Â  Â  font-weight: bold;
Â  }
Â  .cella.bianco { 
Â  Â  background-color: #87A0CC;Â 
Â  Â  color: white;Â 
Â  }
Â  .cella.giallo { 
Â  Â  background-color: #ffeb99;Â 
Â  Â  color: #555;Â 
Â  }
Â  .cella.verde { 
Â  Â  background-color: #a0e7a0;Â 
Â  Â  color: #333;Â 
Â  }
Â  .cella.blu { 
Â  Â  background-color: #c0d9f0;Â 
Â  Â  color: #4c565c;Â 
Â  }
Â Â 
Â  /* CLASSE PER EVIDENZIAZIONE RICERCA */
Â  .cella.evidenziato {
Â  Â  background-color: #4da6ff !important;
Â  Â  color: white !important;
Â  Â  transform: scale(1.05) translateY(-5px);Â 
Â  Â  box-shadow: 0 8px 20px rgba(77, 166, 255, 0.5);
Â  Â  border: 3px solid white;Â 
Â  }

Â  .cella .prezzo-vecchio {
Â  Â  text-decoration: line-through;
Â  Â  font-weight: normal;Â 
Â  Â  font-size: 0.85em;
Â  Â  color: #666;
Â  Â  margin-bottom: 2px;
Â  Â  word-break: break-word;
Â  }

Â  .cella .prezzo-nuovo {
Â  Â  font-weight: bold;Â 
Â  Â  color: black;
Â  Â  margin-bottom: 2px;
Â  Â  word-break: break-word;
Â  }

Â  .cella .comune {
Â  Â  font-size: 0.8em;
Â  Â  color: #333;
Â  Â  word-break: break-word;
Â  }

Â  .cella .rif {
Â  Â  font-weight: bold;
Â  Â  margin-bottom: 2px;
Â  Â  word-break: break-word;
Â  }

Â  /* Pulsante Ribasso */
Â  .cella button {
Â  Â  margin-top: 4px;
Â  Â  font-size: 10px;
Â  Â  padding: 2px 5px;
Â  Â  border: none;
Â  Â  border-radius: 5px;
Â  Â  background-color: #ff8c00; 
Â  Â  color: white;
Â  Â  cursor: pointer;
Â  Â  transition: background-color 0.3s, transform 0.3s;
Â  }

Â  .cella button:hover {Â 
Â  Â  Â  background-color: #e67e00;Â 
Â  Â  Â  transform: scale(1.1);Â 
Â  }
Â Â 
Â  .conteggi {
Â  Â  margin-top: 20px;
Â  Â  font-weight: bold;
Â  Â  display: flex;
Â  Â  gap: 30px;
Â  Â  justify-content: center;
Â  Â  font-size: 14px;
Â  Â  margin-bottom: 20px;
Â  }

Â  /* MODAL, TOAST, LOADING STYLES (non modificate) */
Â  #loading {
Â  Â  position: absolute;
Â  Â  top: 50%;
Â  Â  left: 50%;
Â  Â  transform: translate(-50%, -50%);
Â  Â  background: rgba(255, 255, 255, 0.9);
Â  Â  padding: 15px 30px;
Â  Â  border-radius: 10px;
Â  Â  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
Â  Â  font-size: 1.2em;
Â  Â  font-weight: bold;
Â  Â  color: #b30933;
Â  Â  z-index: 1000;
Â  Â  display: none;
Â  }

Â  #toast {
Â  Â  position: fixed;
Â  Â  bottom: 20px;
Â  Â  left: 50%;
Â  Â  transform: translateX(-50%);
Â  Â  background-color: #333;
Â  Â  color: white;
Â  Â  padding: 10px 20px;
Â  Â  border-radius: 5px;
Â  Â  opacity: 0.9;
Â  Â  z-index: 1000;
Â  Â  display: none;
Â  }

Â  #modal {
Â  Â  position: fixed;
Â  Â  top: 0;
Â  Â  left: 0;
Â  Â  width: 100%;
Â  Â  height: 100%;
Â  Â  background-color: rgba(0, 0, 0, 0.5);
Â  Â  display: none;
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  Â  z-index: 1000;
Â  }

Â  #modalContainer {
Â  Â  background-color: white;
Â  Â  padding: 25px;
Â  Â  border-radius: 10px;
Â  Â  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
Â  Â  max-width: 400px;
Â  Â  width: 90%;
Â  }

Â  #modalContent {
Â  Â  margin-bottom: 20px;
Â  Â  font-size: 16px;
Â  }

Â  #modalButtons {
Â  Â  display: flex;
Â  Â  justify-content: flex-end;
Â  Â  gap: 10px;
Â  }

Â  #modalCancel, #modalConfirm {
Â  Â  font-size: 14px;
Â  Â  padding: 8px 15px;
Â  Â  cursor: pointer;
Â  Â  margin-top: 0;
Â  }

Â  #modalConfirm {
Â  Â  background-color: #b30933;
Â  Â  color: white;
Â  }

Â  #modalCancel {
Â  Â  background-color: #ccc;
Â  Â  color: #333;
Â  }

Â  .fade { animation: fadeIn 0.4s ease-in-out; }
Â  @keyframes fadeIn {
Â  Â  0% { opacity: 0; transform: scale(0.9); }
Â  Â  100% { opacity: 1; transform: scale(1); }
Â  }
</style>
</head>
<body>

<h1>Dashboard Vetrine3</h1>

<div class="dashboard-controls">
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="selezionaAgenzia">Seleziona Agenzia:</label>
Â  Â  Â  Â  <select id="selezionaAgenzia">
Â  Â  Â  Â  Â  Â  <option value="portogruaro">Portogruaro</option>
Â  Â  Â  Â  Â  Â  <option value="sanvito">San Vito</option>
Â  Â  Â  Â  Â  Â  <option value="pordenone">Pordenone</option>
Â  Â  Â  Â  </select>
Â  Â  </div>

Â  Â  <div class="cerca-container">
Â  Â  Â  Â  <input type="text" id="inputRicerca" placeholder="Cerca RIF">
Â  Â  Â  Â  <button id="bottoneCerca">Cerca</button>
Â  Â  </div>

Â  Â  <div class="sostituzione-container">
Â  Â  Â  Â  <label for="rifVecchio">Sostituisci:</label>
Â  Â  Â  Â  <input type="text" id="rifVecchio" placeholder="RIF Vecchio">
Â  Â  Â  Â  <label for="rifNuovo">con:</label>
Â  Â  Â  Â  <input type="text" id="rifNuovo" placeholder="RIF Nuovo">
Â  Â  Â  Â  <button id="bottoneSostituzione">Sostituisci</button>
Â  Â  </div>
</div>

<div class="conteggi">
Â  <div>Cartelli totali: <span id="totale">0</span></div>
Â  <div>Ribassi da fare: <span id="ribassi">0</span></div>
Â  <div>Offline: <span id="offline">0</span></div>
</div>

<div class="griglia" id="griglia">
</div>

<div id="loading">Caricamento dati...</div>

<div id="modal">
Â  Â  <div id="modalContainer">
Â  Â  Â  Â  <div id="modalContent"></div>
Â  Â  Â  Â  <div id="modalButtons">
Â  Â  Â  Â  Â  Â  <button id="modalCancel">Annulla</button>
Â  Â  Â  Â  Â  Â  <button id="modalConfirm">Conferma</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="toast"></div>

<script>
// ======================================================================
// CONFIGURAZIONE API E FUNZIONI (da api.js)
// ======================================================================

// !!! AGGIORNA QUESTO VALORE CON IL TUO WORKER URL !!!
const WORKER_BASE = "https://vetrine.it-immobiliarenordest.workers.dev";Â 
const TIMEOUT_MS = 8000;

async function fetchWithTimeout(url, opts = {}, timeout = TIMEOUT_MS) {
Â  Â  const controller = new AbortController();
Â  Â  const id = setTimeout(() => controller.abort(), timeout);
Â  Â  try {
Â  Â  Â  Â  const res = await fetch(url, { ...opts, signal: controller.signal });
Â  Â  Â  Â  clearTimeout(id);
Â  Â  Â  Â  return res;
Â  Â  } catch (err) {
Â  Â  Â  Â  clearTimeout(id);
Â  Â  Â  Â  throw err;
Â  Â  }
}

async function getAllVetrine() {
Â  Â  const res = await fetchWithTimeout(`${WORKER_BASE}/vetrine`);
Â  Â  if (!res.ok) throw new Error("Errore caricamento vetrine");
Â  Â  const body = await res.json();
Â  Â  if (!body.success) throw new Error(body.error || "Errore API");
Â  Â  return body.data;Â 
}

async function searchByRif(rif) {
Â  Â  // Questa rotta non Ã¨ presente nel tuo worker attuale, ma la manteniamo per il frontend
Â  Â  // Il worker attuale carica tutto e gestisce la ricerca in memoria.
Â  Â  // Per ora usiamo solo il caricamento completo.
Â  Â  showToast("Ricerca RIF attiva solo in memoria, non su API esterna.", 2500);
Â  Â  return null;
}

async function postRibasso(rif, nuovoPrezzo) {
Â  Â  const res = await fetchWithTimeout(`${WORKER_BASE}/vetrine/ribasso`, {
Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  body: JSON.stringify({ rif: String(rif), nuovo_prezzo: Number(nuovoPrezzo) })
Â  Â  }, TIMEOUT_MS);
Â  Â  return res.json();
}

async function postPlaceholder(rif, placeholder) {
Â  Â  const res = await fetchWithTimeout(`${WORKER_BASE}/vetrine/placeholder`, {
Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  body: JSON.stringify({ rif: String(rif), placeholder: !!placeholder })
Â  Â  }, TIMEOUT_MS);
Â  Â  return res.json();
}

// ðŸ†• NUOVA FUNZIONE API PER LA SOSTITUZIONE
async function postSostituzione(rifVecchio, rifNuovo) {
Â  Â  const res = await fetchWithTimeout(`${WORKER_BASE}/vetrine/sostituzione`, {
Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  body: JSON.stringify({ 
Â  Â  Â  Â  Â  Â  rif_vecchio: String(rifVecchio), 
Â  Â  Â  Â  Â  Â  rif_nuovo: String(rifNuovo) 
Â  Â  Â  Â  })
Â  Â  }, TIMEOUT_MS);
Â  Â  return res.json();
}


// ======================================================================
// VARIABILI GLOBALI E UTILITY (da ui.js)
// ======================================================================

const agenzieBlocchi = {
Â  portogruaro: [4, 4, 3, 4, 5],
Â  sanvito: [2, 2, 2],
Â  pordenone: [3, 5]
};
const righe = 3;
let allData = {}; 
let rifDaCercare = '';
let pendingAction = null; 

// Elementi UI
const grigliaDiv = document.getElementById('griglia');
const selectAgenzia = document.getElementById('selezionaAgenzia');
const inputRicerca = document.getElementById('inputRicerca');
const bottoneCerca = document.getElementById('bottoneCerca');
// ðŸ†• NUOVI INPUT PER SOSTITUZIONE
const inputRifVecchio = document.getElementById('rifVecchio');
const inputRifNuovo = document.getElementById('rifNuovo');
const bottoneSostituzione = document.getElementById('bottoneSostituzione');

const modalBack = document.getElementById('modal');
const modalContent = document.getElementById('modalContent');
const modalCancel = document.getElementById('modalCancel');
const modalConfirm = document.getElementById('modalConfirm');
const loadingEl = document.getElementById('loading');
const toast = document.getElementById('toast');


function formatMoney(n){
Â  Â  return Number(n).toLocaleString('it-IT');
}

function daysSince(dateStr){
Â  Â  if (!dateStr) return 9999;
Â  Â  const d = new Date(dateStr);
Â  Â  const now = new Date();
Â  Â  const diff = now - d;
Â  Â  return Math.floor(diff / (1000*60*60*24));
}

function showModal(html, confirmText = "Conferma"){
Â  Â  modalContent.innerHTML = html;
Â  Â  modalConfirm.textContent = confirmText;
Â  Â  modalBack.style.display='flex';
}

function showToast(msg, ms=2500){
Â  Â  toast.innerText = msg;
Â  Â  toast.style.display='block';
Â  Â  setTimeout(()=>{ toast.style.display='none'; }, ms);
}

function showLoading(flag){
Â  Â  loadingEl.style.display = flag ? 'block' : 'none';
}

// Classificazione Stati (Rosso, Giallo, ecc.)
function computeClass(item){
Â  Â  if (!item || !item.rif) return 'rosso'; // Tratta le celle vuote come OFFLINE/Rosso
Â  Â  if (item.prezzo_myagency === 0) return 'rosso'; // Offline forzato
Â  Â  if (item.segnaposto) return 'bianco';
Â  Â Â 
Â  Â  const prezzo = Number(item.prezzo || 0);
Â  Â  const prezzo_ref = Number(item.prezzo_myagency || item.prezzo || 0);
Â  Â  const days = daysSince(item.timestamp);
Â  Â Â 
Â  Â  if (prezzo > prezzo_ref) return 'giallo'; // Ribasso da fare
Â  Â  if (days > 180) return 'blu';
Â  Â  return 'verde';
}

// ======================================================================
// LOGICA DI CARICAMENTO E AGGIORNAMENTO DATI
// ======================================================================

async function loadData(){
Â  Â  showLoading(true);
Â  Â  try {
Â  Â  Â  Â  const data = await getAllVetrine();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Raggruppa i dati per agenzia per la visualizzazione corretta della griglia
Â  Â  Â  Â  const grouped = {};
Â  Â  Â  Â  data.forEach(it => {
Â  Â  Â  Â  Â  Â  const ag = it.agenzia || 'portogruaro';
Â  Â  Â  Â  Â  Â  grouped[ag] = grouped[ag] || [];
Â  Â  Â  Â  Â  Â  grouped[ag].push(it);
Â  Â  Â  Â  });
Â  Â  Â  Â  allData = grouped;
Â  Â  Â  Â Â 
Â  Â  Â  Â  showLoading(false);
Â  Â  Â  Â  renderGriglia();
Â  Â  } catch (err) {
Â  Â  Â  Â  showLoading(false);
Â  Â  Â  Â  showToast('Errore caricamento: ' + err.message, 3500);
Â  Â  }
}

function renderGriglia(highlightRif){
Â  Â  const agenzia = selectAgenzia.value;
Â  Â  const blocchi = agenzieBlocchi[agenzia];
Â  Â  // Assicurati di usare una copia per non modificare l'array originale
Â  Â  const immobiliFiltrati = (allData[agenzia] || []).slice();Â 

Â  Â  grigliaDiv.innerHTML = '';
Â  Â  let indice = 0;
Â  Â  let countRibasso = 0;
Â  Â  let countOffline = 0;

Â  Â  const celleTotali = blocchi.reduce((sum, current) => sum + current, 0) * righe;
Â  Â  const immobiliPerGriglia = [...immobiliFiltrati];

Â  Â  // Riempie con null fino al numero massimo di celle
Â  Â  while (immobiliPerGriglia.length < celleTotali) {
Â  Â  Â  Â  immobiliPerGriglia.push(null);
Â  Â  }

Â  Â  // Calcolo Conteggi
Â  Â  immobiliFiltrati.forEach(immobile => {
Â  Â  Â  Â  const cls = computeClass(immobile);
Â  Â  Â  Â  if (cls === 'giallo') countRibasso++;
Â  Â  Â  Â  // Solo gli immobili con RIF valido e class Rosso contano come offline
Â  Â  Â  Â  if (cls === 'rosso' && immobile && immobile.rif) countOffline++; 
Â  Â  });

Â  Â  document.getElementById('totale').textContent = immobiliFiltrati.length;
Â  Â  document.getElementById('ribassi').textContent = countRibasso;
Â  Â  document.getElementById('offline').textContent = countOffline;

Â  Â  for (let r = 0; r < righe; r++) {
Â  Â  Â  Â  const rigaDiv = document.createElement('div');
Â  Â  Â  Â  rigaDiv.classList.add('riga');

Â  Â  Â  Â  blocchi.forEach((colonne) => {
Â  Â  Â  Â  Â  Â  const bloccoDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  bloccoDiv.classList.add('blocco');

Â  Â  Â  Â  Â  Â  for (let c = 0; c < colonne; c++) {
Â  Â  Â  Â  Â  Â  Â  Â  const immobile = immobiliPerGriglia[indice];
Â  Â  Â  Â  Â  Â  Â  Â  const cella = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  cella.classList.add('cella', 'fade');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const cls = computeClass(immobile);
Â  Â  Â  Â  Â  Â  Â  Â  cella.classList.add(cls);

Â  Â  Â  Â  Â  Â  Â  Â  // CONTENUTO DELLA CELLA
Â  Â  Â  Â  Â  Â  Â  Â  if (cls === 'rosso') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (immobile && immobile.rif) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cella.innerHTML = `<div class="rif">${immobile.rif}</div><div>OFFLINE</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cella.textContent = ""; // Cella di riempimento vuota (non un immobile offline)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cella.classList.remove('rosso'); // Rimuove rosso per le celle vuote
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cella.style.backgroundColor = '#e9ecef'; // Colore leggero
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cella.style.cursor = 'default';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cella.style.boxShadow = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else if (cls === 'bianco') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cella.innerHTML = `<div class="rif">${immobile.rif}</div><div>SEGNAPOSTO</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (immobile) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const prezzoCorrente = formatMoney(immobile.prezzo);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cls === 'giallo') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const prezzoMyAgency = formatMoney(immobile.prezzo_myagency);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cella.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="rif">${immobile.rif}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="prezzo-vecchio">${prezzoCorrente} â‚¬</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="prezzo-nuovo">â†“ ${prezzoMyAgency} â‚¬</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cella.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="rif">${immobile.rif}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="prezzo-nuovo">${prezzoCorrente} â‚¬</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="comune">${immobile.comune}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // LOGICA DI EVIDENZIAZIONE
Â  Â  Â  Â  Â  Â  Â  Â  if (immobile && immobile.rif && rifDaCercare && immobile.rif.toLowerCase() === rifDaCercare.toLowerCase()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cella.classList.add('evidenziato');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (highlightRif === immobile.rif) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => cella.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // AGGIUNGI PULSANTE RIBASSO (SOLO SU GIALLO)
Â  Â  Â  Â  Â  Â  Â  Â  if (cls === 'giallo') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = "Aggiorna";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onCellAction('ribasso', immobile);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cella.appendChild(btn);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // LOGICA CLICK PER SEGNAPOSTO (SU TUTTE CON RIF VALIDO TRANNE GIALLO)
Â  Â  Â  Â  Â  Â  Â  Â  if (immobile && immobile.rif && cls !== 'giallo') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cella.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onCellAction('placeholder', immobile);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  bloccoDiv.appendChild(cella);
Â  Â  Â  Â  Â  Â  Â  Â  indice++;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  rigaDiv.appendChild(bloccoDiv);
Â  Â  Â  Â  });

Â  Â  Â  Â  grigliaDiv.appendChild(rigaDiv);
Â  Â  }
}

// ======================================================================
// AZIONI CELLA E MODALE (da ui.js)
// ======================================================================

async function onCellAction(action, item){
Â  Â  // Reset eventuale stato di ricerca
Â  Â  rifDaCercare = '';
Â  Â  
Â  Â  if (action === 'ribasso') {
Â  Â  Â  Â  const rif = item.rif;
Â  Â  Â  Â  const nuovoPrezzo = item.prezzo_myagency; 
Â  Â  Â  Â Â 
Â  Â  Â  Â  showModal(`
Â  Â  Â  Â  Â  Â  <div>Confermi l'aggiornamento del prezzo per RIF: <b>${rif}</b>?</div>
Â  Â  Â  Â  Â  Â  <div style="margin-top:8px">Il prezzo passerÃ  da <b>â‚¬ ${formatMoney(item.prezzo)}</b> a <b>â‚¬ ${formatMoney(nuovoPrezzo)}</b>.</div>
Â  Â  Â  Â  `, "Conferma Ribasso");
Â  Â  Â  Â Â 
Â  Â  Â  Â  pendingAction = { type: 'ribasso', rif: rif, payload: { nuovo: nuovoPrezzo } };
Â  Â  Â  Â Â 
Â  Â  } else if (action === 'placeholder') {
Â  Â  Â  Â  const newVal = !item.segnaposto;
Â  Â  Â  Â  const statoTesto = newVal ? 'SI' : 'NO';
Â  Â  Â  Â Â 
Â  Â  Â  Â  showModal(`
Â  Â  Â  Â  Â  Â  <div>RIF: <b>${item.rif}</b></div>
Â  Â  Â  Â  Â  Â  <div>Impostare Segnaposto: <b>${statoTesto}</b>?</div>
Â  Â  Â  Â  `, "Conferma");
Â  Â  Â  Â Â 
Â  Â  Â  Â  pendingAction = { type: 'placeholder', rif: item.rif, payload: { placeholder: newVal } };
Â  Â  } else if (action === 'sostituzione') {
Â  Â  Â  Â  const rifVecchio = item.rifVecchio;
Â  Â  Â  Â  const rifNuovo = item.rifNuovo;

Â  Â  Â  Â  showModal(`
Â  Â  Â  Â  Â  Â  <div>Attenzione: stai per sostituire il RIF <b>${rifVecchio}</b></div>
Â  Â  Â  Â  Â  Â  <div>con i dati completi del RIF <b>${rifNuovo}</b>, recuperati dall'API esterna.</div>
Â  Â  Â  Â  Â  Â  <div style="margin-top: 10px; font-weight: bold; color: #b30933;">Questa azione Ã¨ irreversibile. Procedere?</div>
Â  Â  Â  Â  `, "Conferma Sostituzione");

Â  Â  Â  Â  pendingAction = { type: 'sostituzione', payload: { rif_vecchio: rifVecchio, rif_nuovo: rifNuovo } };
Â  Â  }
}

// Handler generale per il click su Conferma del Modale
modalConfirm.addEventListener('click', async () => {
Â  Â  if (!pendingAction) return;

Â  Â  modalBack.style.display = 'none';
Â  Â  const { type, rif, payload } = pendingAction;
Â  Â  showToast('Eseguo aggiornamento...', 2000);

Â  Â  try {
Â  Â  Â  Â  let resp;
Â  Â  Â  Â  if (type === 'ribasso') {
Â  Â  Â  Â  Â  Â  resp = await postRibasso(rif, payload.nuovo);
Â  Â  Â  Â  } else if (type === 'placeholder') {
Â  Â  Â  Â  Â  Â  resp = await postPlaceholder(rif, payload.placeholder);
Â  Â  Â  Â  } else if (type === 'sostituzione') { // ðŸ†• LOGICA DI SOSTITUZIONE
Â  Â  Â  Â  Â  Â  resp = await postSostituzione(payload.rif_vecchio, payload.rif_nuovo);
Â  Â  Â  Â  }

Â  Â  Â  Â  if (resp && resp.success) {
Â  Â  Â  Â  Â  Â  showToast('Aggiornamento riuscito: ' + resp.message, 2500);
Â  Â  Â  Â  Â  Â  await loadData(); 
Â  Â  Â  Â  Â  Â  // Pulisce i campi di input dopo una sostituzione riuscita
Â  Â  Â  Â  Â  Â  if (type === 'sostituzione') {
Â  Â  Â  Â  Â  Â  Â  Â  inputRifVecchio.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  inputRifNuovo.value = '';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  showToast('Errore: ' + (resp.error || 'unknown'), 3500);
Â  Â  Â  Â  }
Â  Â  } catch (err) {
Â  Â  Â  Â  showToast('Errore rete o timeout: ' + err.message, 3500);
Â  Â  } finally {
Â  Â  Â  Â  pendingAction = null;
Â  Â  }
});

modalCancel.addEventListener('click', ()=> { modalBack.style.display='none'; pendingAction=null; });
modalBack.addEventListener('click', (e) => { if(e.target===modalBack){ modalBack.style.display='none'; pendingAction=null;}});


// ======================================================================
// GESTIONE RICERCA, URL E SOSTITUZIONE
// ======================================================================

function getAgenziaFromUrl() {
Â  Â  const params = new URLSearchParams(window.location.search);
Â  Â  return params.get('agenzia');Â 
}

function cambiaAgenziaConUrl() {
Â  Â  const nuovaAgenzia = selectAgenzia.value;
Â  Â  const currentUrl = new URL(window.location.href);
Â  Â Â 
Â  Â  currentUrl.searchParams.set('agenzia', nuovaAgenzia);
Â  Â Â 
Â  Â  // Ricarica la pagina con il nuovo URL per applicare il filtro
Â  Â  window.location.href = currentUrl.toString();
}

async function onSearch() {
Â  Â  const rif = inputRicerca.value.trim().toLowerCase();
Â  Â  if (!rif) return showToast('Inserisci un RIF', 2000);
Â  Â Â 
Â  Â  // Cerca il RIF nei dati giÃ  caricati
Â  Â  let immobileTrovato = null;
Â  Â  for (const agenzia in allData) {
Â  Â  Â  Â  immobileTrovato = allData[agenzia].find(i => i.rif && i.rif.toLowerCase() === rif);
Â  Â  Â  Â  if (immobileTrovato) break;
Â  Â  }
Â  Â Â 
Â  Â  if (!immobileTrovato) return showToast(`Nessun immobile con RIF ${rif.toUpperCase()}`, 3000);

Â  Â  // Se trovato, imposta l'agenzia corretta e renderizza
Â  Â  selectAgenzia.value = immobileTrovato.agenzia;
Â  Â Â 
Â  Â  rifDaCercare = immobileTrovato.rif.toLowerCase();
Â  Â  renderGriglia(immobileTrovato.rif); // Passa il RIF per l'highlight e lo scroll
Â  Â  showToast(`Trovato RIF ${immobileTrovato.rif}`, 2000);
}

// ðŸ†• NUOVA FUNZIONE PER GESTIRE LA SOSTITUZIONE
function onSostituzioneClick() {
Â  Â  const rifVecchio = inputRifVecchio.value.trim().toUpperCase();
Â  Â  const rifNuovo = inputRifNuovo.value.trim().toUpperCase();

Â  Â  if (!rifVecchio || !rifNuovo) {
Â  Â  Â  Â  return showToast('Devi inserire entrambi i RIF (Vecchio e Nuovo).', 3000);
Â  Â  }

Â  Â  if (rifVecchio === rifNuovo) {
Â  Â  Â  Â  return showToast('I RIF Vecchio e Nuovo non possono essere uguali.', 3000);
Â  Â  }

Â  Â  // Innesca l'azione nel gestore modale
Â  Â  onCellAction('sostituzione', { rifVecchio, rifNuovo });
}


// ======================================================================
// INIZIALIZZAZIONE E EVENT LISTENERS
// ======================================================================

// Imposta l'agenzia all'avvio se Ã¨ presente nell'URL
const agenziaUrl = getAgenziaFromUrl();
if (agenziaUrl && agenzieBlocchi.hasOwnProperty(agenziaUrl)) {
Â  Â  selectAgenzia.value = agenziaUrl;
}

selectAgenzia.addEventListener('change', cambiaAgenziaConUrl);Â 
bottoneCerca.addEventListener('click', onSearch);
inputRicerca.addEventListener('keypress', (e) => {Â 
Â  Â  if (e.key === 'Enter') {
Â  Â  Â  Â  onSearch();
Â  Â  }
});

// ðŸ†• EVENT LISTENER PER SOSTITUZIONE
bottoneSostituzione.addEventListener('click', onSostituzioneClick);

// Avvia il caricamento iniziale dei dati
loadData();
</script>

</body>
</html>
