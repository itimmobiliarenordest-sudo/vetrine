<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Dashboard Vetrine</title>
<style>
  body { font-family: Arial, sans-serif; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background-color: #f4f4f4; }
  .normale { background-color: #fff; }
  .ribasso { background-color: #ffecb3; } /* giallo per ribasso */
  .segnaposto { background-color: #e0e0e0; } /* grigio chiaro */
  button { padding: 4px 8px; cursor: pointer; }
  #conteggi { margin-top: 10px; }
</style>
</head>
<body>

<h1>Dashboard Vetrine</h1>

<div>
    <label for="agenziaFilter">Seleziona agenzia: </label>
    <select id="agenziaFilter">
        <option value="">-- Scegli Agenzia --</option>
        <option value="portogruaro">Portogruaro</option>
        <option value="sanvito">San Vito</option>
        <option value="pordenone">Pordenone</option>
    </select>
</div>

<div id="conteggi" style="display:none;">
    <p>Totale cartelli: <span id="totale">0</span></p>
    <p>Ribassi da fare: <span id="ribassi">0</span></p>
    <p>Offline (segnaposto): <span id="offline">0</span></p>
</div>

<table id="vetrinaTable" style="display:none;">
  <thead>
    <tr>
      <th>Rif</th>
      <th>Prezzo</th>
      <th>Prezzo MyAgency</th>
      <th>Comune</th>
      <th>Vetrina</th>
      <th>Segnaposto</th>
      <th>Ribasso</th>
      <th>Cambia</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let immobiliGlobal = [];

async function caricaVetrine() {
    const res = await fetch("https://vetrine.it-immobiliarenordest.workers.dev/vetrine");
    const json = await res.json();

    if (!json.success) {
        console.error("Errore:", json.message);
        return;
    }

    immobiliGlobal = json.data;
}

function aggiornaTabella(agenzia) {
    const tbody = document.querySelector("#vetrinaTable tbody");
    tbody.innerHTML = "";

    if (!agenzia) return;

    const filtrati = immobiliGlobal.filter(i => i.agenzia === agenzia);
    let ribassiCount = 0;
    let offlineCount = 0;

    filtrati.forEach(i => {
        const tr = document.createElement("tr");
        tr.className = i.segnaposto ? "segnaposto" : (i.prezzo_myagency < i.prezzo ? "ribasso" : "normale");

        if (!i.segnaposto && i.prezzo_myagency < i.prezzo) ribassiCount++;
        if (i.segnaposto) offlineCount++;

        tr.innerHTML = `
            <td>${i.rif}</td>
            <td>${i.prezzo}</td>
            <td>${i.prezzo_myagency}</td>
            <td>${i.comune}</td>
            <td>${i.vetrina}</td>
            <td>${i.segnaposto ? "âœ”" : ""}</td>
            <td>${!i.segnaposto ? `<button onclick="ribassa(${i.id})">Ribassa</button>` : ""}</td>
            <td><button onclick="cambia(${i.id})">Cambia</button></td>
        `;
        tbody.appendChild(tr);
    });

    document.getElementById("totale").textContent = filtrati.length;
    document.getElementById("ribassi").textContent = ribassiCount;
    document.getElementById("offline").textContent = offlineCount;

    document.getElementById("conteggi").style.display = filtrati.length ? "block" : "none";
    document.getElementById("vetrinaTable").style.display = filtrati.length ? "table" : "none";
}

function ribassa(id) {
    if (confirm("Confermi il ribasso del prezzo?")) {
        console.log("Ribasso confermato per ID:", id);
        // Aggiornamento KV qui
    }
}

function cambia(id) {
    console.log("Cambia immobile ID:", id);
    // Apri popup per cambio immobile o segnaposto
}

document.getElementById("agenziaFilter").addEventListener("change", (e) => {
    aggiornaTabella(e.target.value);
});

caricaVetrine();
</script>

</body>
</html>
